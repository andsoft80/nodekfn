<!DOCTYPE html>
<html ng-app="myApp">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Cache-Control" content="no-cache" />
        <meta http-equiv="Pragma" content="no-cache" />

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script>

        <script src="http://localhost:3000/sidebar.min.js" type="text/javascript"></script>
        <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400" rel="stylesheet" />
        <link rel="stylesheet" href="http://localhost:3000/lib/fontello.css" />
        <!--<link rel="stylesheet" href="http://localhost:3000/lib/normalize.css" />-->
        <link href="http://localhost:3000/sidebar.css" rel="stylesheet" type="text/css"/>
        <link href="http://localhost:3000/index.css" rel="stylesheet" type="text/css"/>        
        <!--<link href="sidebar-0.2.0/css/index.css" rel="stylesheet" type="text/css"/>-->
        <!--<script src="//ajax.aspnetcdn.com/ajax/jquery.ui/1.10.3/jquery-ui.min.js"></script>-->
        <script src="http://localhost:3000/jquery-ui.js" type="text/javascript"></script>
        <link rel="stylesheet" href="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.10.3/themes/sunny/jquery-ui.css">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <link href="https://fonts.googleapis.com/css?family=Roboto:100" rel="stylesheet">

        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.5/themes/default/style.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.5/jstree.min.js"></script>        

        <title>Караоке плеер</title>
        <script>
            ////////////////////////////////////////////
            var app = angular.module('myApp', []);
            app.controller('myCtrl', function ($scope) {
                $scope.playList = [];
                $scope.getPlayList = function () {

                    $.ajax({
                        type: "GET",
                        async: false,
                        url: "http://localhost:3000/list",
                        success: function (data) {
                            $scope.playList = JSON.parse(data);
                            $scope.$apply();
                        }
                    });


//                    $.ajax({
//                        type: "GET",
//                        async: false,
//                        url: "http://localhost:3000/listinit",
//                        success: function (data) {
//                            alert(data);
//                        }
//                    });                    

                };
                $scope.play = function (fileName) {
                    fn = 'downloads';
                    slash = '%5C';
                    fn = fn + slash + fileName;
                    $('#jsi-nav').data('sidebar').pull();
                    $().JqueryFunction(fn);
                };
//                $("form#transferForm").submit(function () {
//
//                    var formData = new FormData($(this)[0]);
//                    $.ajax({
//                        url: '/transfer',
//                        type: 'POST',
//                        data: formData,
//                        async: false,
//                        success: function (data) {
//                            var entry = {
//                                "id": "",
//                                "name": ""
//
//                            };
//                            entry.id = $scope.playList.length + 1;
//                            entry.name = data;
//                            $scope.playList.push(entry);
//                            $scope.$apply();
//                        },
//                        cache: false,
//                        contentType: false,
//                        processData: false
//                    });
//                    return false;
//                });
                $scope.addSong = function () {

                    $("#selectSong").css({display: 'block'});
                    tree = $('#tree').jstree({

                        "checkbox": {
                            //"keep_selected_style": false
                        },
                        "themes": {"stripes": true},
                        "file": {
                            "icon": "glyphicon glyphicon-file",

                        },
                        'core': {
                            'data': [
                                {"text": "Root node", "children": [
                                        {"text": "Child node 1"},
                                        {"text": "Child node 2"}
                                    ]
                                }
                            ]
                        },
                        "plugins": [
                             "wholerow", "checkbox"
                        ]

                    });
                    tree.close_all();
                    tree.uncheck_all ();

                };
                $scope.closeSelectSong = function () {

                    $("#selectSong").css({display: 'none'});
                    

                };

                $scope.listUp = function (id) {

                    $.ajax({
                        type: "GET",

                        url: "http://localhost:3000/list_up/" + id,
                        success: function (data) {

                            $scope.playList = JSON.parse(data);
                            $scope.$apply();
                        }
                    });


                };

                $scope.listDown = function (id) {

                    $.ajax({
                        type: "GET",

                        url: "http://localhost:3000/list_down/" + id,
                        success: function (data) {
                            $scope.playList = JSON.parse(data);
                            $scope.$apply();
                        }
                    });

                };

                $scope.listDelete = function (id) {

                    $.ajax({
                        type: "GET",

                        url: "http://localhost:3000/list_delete/" + id,
                        success: function (data) {
                            $scope.playList = JSON.parse(data);
                            $scope.$apply();
                        }
                    });

                };

            });
            ////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////
var reader = null;
var a = null;
var b = null;
var input = null;
var key = null;
var entryArr = [];
var tarr = [];
var marr = [];
var lineArrJson = [];
var Artist = '';
var Title = '';
var res = null;


function getFileBinary(filename) {
    res = null;
    var data = fs.readFileSync(filename);

    res = (data.toString('binary'));



    return res;
    return res;
}

function getFileHex(filename) {

    res = null;
    var data = fs.readFileSync(filename);

    res = (data.toString('hex'));



    return res;
}


function readbytes(offset, input, n) {
    arr = input.slice(offset, (offset + n));

    return arr;
}
function bufferToHex(buffer) {
    return Array
            .from(new Uint8Array(buffer))
            .map(b => b.toString(16).padStart(2, "0"))
            .join("");
}
function hex2a(hexx) {//for hex string
    var hex = hexx.toString();//force conversion
    var hex = hexx;
    var str = '';
    for (var i = 0; (i < hex.length && hex.substr(i, 2) !== '00'); i += 2)
        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
    return str;
}
function hexarr2a(hexx) {//for hex arr

    var hex = hexx;
    var str = '';
    for (var i = 0; (i < hex.length && hex[i] !== '00'); i ++)
        str += String.fromCharCode(parseInt(hex[i], 16));
    return str;
}
function decimalToHex(d, padding) {
    var hex = Number(d).toString(16);
    padding = typeof (padding) === "undefined" || padding === null ? padding = 2 : padding;

    while (hex.length < padding) {
        hex = "0" + hex;
    }

    return hex;
}
function bin2hex(bin)
{

    var i = 0, l = bin.length, chr, hex = '';

    for (i; i < l; ++i)
    {

        chr = bin.charCodeAt(i).toString(16);

        hex += chr.length < 2 ? '0' + chr : chr;

    }

    return hex;

}

function readDWord(arr, offset) {
    b1 = parseInt(readbytes(offset, arr, 1), 16);
    b2 = parseInt(readbytes(offset + 1, arr, 1), 16);
    b3 = parseInt(readbytes(offset + 2, arr, 1), 16);
    b4 = parseInt(readbytes(offset + 3, arr, 1), 16);

    return b4 << 24 | b3 << 16 | b2 << 8 | b1;
}
function hexToBase64(str) {
    return btoa(String.fromCharCode.apply(null, str.replace(/\r|\n/g, "").replace(/([\da-fA-F]{2}) ?/g, "0x$1 ").replace(/ +$/, "").split(" ")));
}

function uint8ArrToString(arr) {
    hex = [];
    for (i = 0; i < arr.length; i++) {
        hex.push(decimalToHex(arr[i]));
    }
    return hexarr2a(hex);
}

function uint8ToHexArr(arr) {
    hex = [];
    for (i = 0; i < arr.length; i++) {
        hex.push(decimalToHex(arr[i]));
    }
    return hex;
}

function bin2String(array) {
    var result = "";
    for (var i = 0; i < array.length; i++) {
        result += String.fromCharCode(parseInt(array[i], 2));
    }
    return result;
}

function prepFile(playFileName) {
    tarr = [];
    marr = [];
    entryArr = [];
//                    var u = new Uint8Array(reader.result);
    a = getFileHex(playFileName);

    var result = [];

    for (var i = 0; i < a.length; i += 2)
    {
        result.push(parseInt(a.substring(i, i + 2), 16));
    }
    var u = Uint8Array.from(result);
    //var u = Buffer.from(result);
    //var u = res;
    //console.log(u);



    //header FLID strval - ключ AES для ///////////////////
    offset = 4;
    tag = '';
    tryc = 0;
    while (tag !== 'ENDH') {
        if (tryc > 20) {

            return false;
        }
        tag = uint8ArrToString(readbytes(offset, u, 4));
        //console.log(tag);
        offset = offset + 4;
        type = (readbytes(offset, u, 1));
        offset++;
        strval = '';
        if (type == '2') {
            console.log('lenval ');
            lenval = (readbytes(offset, u, 4));

            offset = offset + 4;

            strval = uint8ArrToString(readbytes(offset, u, lenval[0]));

            if (tag == 'FLID') {
                key = (readbytes(offset, u, lenval[0]));

            }
            offset = offset + lenval[0];
        } else {
            lenval = uint8ToHexArr((readbytes(offset, u, 4))).join("");
            offset = offset + 4;
        }



        console.log(tag + ' ' + type + ' ' + lenval + ' ' + strval);
        tryc++;
    }
    ;

    /////////////////////////////////////////////////

    //extract media/////////////////////////////////////
    type_songtext = 1;
    type_music = 2;
    type_image = 3;
    type_font = 4;
    type_video = 5;




//                    numFilesh = (readbytes(offset, a, 4));
    numFiles = (readbytes(offset, u, 4))[0];
    offset = offset + 4;
    //alert(numFiles);
    for (var k = 0; k < numFiles; k++) {
        fileNameLen = (readbytes(offset, u, 4))[0];
        offset = offset + 4;

        fileName = uint8ArrToString(readbytes(offset, u, fileNameLen));
        offset = offset + fileNameLen;

        //fileTypeh = (readbytes(offset, a, 4));
        fileType = (readbytes(offset, u, 4))[0];
        offset = offset + 4;

        fileSize1h = uint8ToHexArr((readbytes(offset, u, 4)));
        fileSize1 = readDWord(fileSize1h, 0);
        offset = offset + 4;

        fileOffseth = uint8ToHexArr((readbytes(offset, u, 4)));
        fileOffset = readDWord(fileOffseth, 0);
        offset = offset + 4;


        fileSize2h = uint8ToHexArr((readbytes(offset, u, 4)));
        fileSize2 = readDWord(fileSize2h, 0);
        offset = offset + 4;


        fileFlagsh = uint8ToHexArr((readbytes(offset, u, 4)));
        fileFlags = readDWord(fileFlagsh, 0);
        offset = offset + 4;


        entry = {
            type: '',
            filename: '',
            length1: '',
            length2: '',
            offset: '',
            flags: '',
            bindata: ''
        };
        entry.type = fileType;
        entry.filename = fileName;
        entry.length1 = fileSize1;
        entry.length2 = fileSize2;
        entry.offset = fileOffset;
        entry.flags = fileFlags;
        entryArr.push(entry);

        //console.log(JSON.stringify(entryArr));


    }

    for (var p = 0; p < numFiles; p++) {
        entryArr[p].offset = entryArr[p].offset + offset;
    }

    //u = [];

    /////////////////////////////////////////////////////
    //console.log(JSON.stringify(entryArr));



//                    var binaryReader = new FileReader();
//                    binaryReader.readAsBinaryString(input.files[0]);
    var aes = new aesjs.AES(key);
//                    binaryReader.onload = function () {
//                        b = binaryReader.result;
    b = getFileBinary(playFileName);

    for (var n = 0; n < entryArr.length - 1; n++) {
        var bd = b.substring(entryArr[n].offset, entryArr[n].offset + entryArr[n].length1);

        entryArr[n].bindata = bd;

    }
    ;



    if (entryArr[entryArr.length - 1].flags === 1) {
        bb = (readbytes(entryArr[entryArr.length - 1].offset, u, entryArr[entryArr.length - 1].length2));
        c = entryArr[entryArr.length - 1].length2 / 16;
        cont = new Uint8Array(entryArr[entryArr.length - 1].length2);

        for (var q = 0; q < c; q++) {
            bb16 = bb.slice(q * 16, q * 16 + 16);
            var decryptedBytes = aes.decrypt(bb16);
            cont.set(decryptedBytes, q * 16);
        }

        realcont = cont.slice(0, entryArr[entryArr.length - 1].length1);
    } else {
        realcont = (readbytes(entryArr[entryArr.length - 1].offset, u, entryArr[entryArr.length - 1].length2));
    }
    ;


    Title = '';
    Artist = '';

    res = uint8ArrToString(realcont);
    console.log(res);

    iniFileTextArr = res.split('\n');
    lineArr = [];
    lineArrJson = [];


    for (var i = 0; i < iniFileTextArr.length; i++) {

        lineEntry = {
            lineText: '',
            timeSplit: [],
            wordSplit: []
        };


        var str = iniFileTextArr[i];
        str = str.replace(/[\r]*/g, '');

        if (str.indexOf('Title=') === 0 & str[str.length - 1] !== '=') {
            p = str.indexOf('=');
            s = str.substring(p + 1, (str.length - p) * 2);
            Title = decodeURIComponent(escape(s));
            console.log(Title);
        }


        if (str.indexOf('Artist=') === 0 & str[str.length - 1] !== '=') {
            p = str.indexOf('=');
            s = str.substring(p + 1, 100000);
            Artist = decodeURIComponent(escape(s));
            //console.log(Artist);

        }


        if (str.indexOf('Text') === 0 &
                str.indexOf('TextCount') !== 0 &
                str[str.length - 1] !== '='
                &
                str.substring(str.length - 2, 100000) !== '=\n'
                &
                str.substring(str.length - 2, 100000) !== '=\r'
                )


        {





            p = str.indexOf('=');
            s = str.substring(p + 1, 100000);
            utfstring = decodeURIComponent(escape(s));

            str_etl = utfstring.replace(/ {1,}/g, " ");//готовая для разбивки по пробелам и по слешам
            str_etl = str_etl.replace(/[\r]*/g, '');//готовая для разбивки по пробелам и по слешам
            lineArr.push(str_etl);



            lineEntry.lineText = str_etl.replace(/[/]*/g, '');//убрали слеши - строка для вывода белым
            var ntarr = str_etl.split(' ');
            for (var k = 0; k < ntarr.length; k++) {
                var sw = ntarr[k] + ' ';//возвращаем пробел, чтобы сшивать
                var swarr = sw.split('/');
                for (var j = 0; j < swarr.length; j++) {
                    lineEntry.wordSplit.push(swarr[j]);
                }
            }

            lineArrJson.push(lineEntry);

            console.log(str_etl);

        }
        if (str.indexOf('Sync') === 0 &
                str[str.length - 1] !== '='
                //&
                //str[str.length - 1] !== '_'
                ) {
            p = str.indexOf('=');
            s = str.substring(p + 1, 10000);
            arr = s.split(',');
            for (var j = 0; j < arr.length; j++) {
                marr.push(arr[j].replace(/[\r]*/g, ''));
            }
        }




    }
    ////timing split

    for (var i = 0; i < lineArr.length; i++) {
        var str = lineArr[i];
        var arr = str.split(' ').join('/').split('/');
        for (var j = 0; j < arr.length; j++) {
            tarr.push(arr[j]);
        }
        tarr[tarr.length - 1] = tarr[tarr.length - 1] + '\n';

    }



    var p = 0;
    for (var r = 0; r < lineArrJson.length; r++) {
        for (var q = 0; q < lineArrJson[r].wordSplit.length; q++) {
            lineArrJson[r].timeSplit.push(marr[p]);
            p++;

        }

    }



    console.log(tarr);
    console.log(marr);
    console.log(JSON.stringify(lineArrJson));
    return true;
}




/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////

//
//
//            var reader = null;
//            var a = null;
//            var b = null;
//            var input = null;
//            var key = null;
//            var entryArr = [];
//            var tarr = [];
//            var marr = [];
            var currPlayData = null;
            function getFileBinary(filename) {
                var res = null;
                $.ajax({
                    type: "GET",
                    async: false,
                    url: "http://localhost:3000/getfilebin/" + filename,
                    success: function (data) {
                        res = data;
                    }
                });
                return res;
            }

            function getFileHex(filename) {
                var res = null;
                $.ajax({
                    type: "GET",
                    async: false,
                    url: "http://localhost:3000/getfilehex/" + filename,
                    success: function (data) {
                        res = data;
                    }
                });
                return res;
            }

            (function ($) {
                $.fn.JqueryFunction = function (playFileName) {
                    addFiles(playFileName)
                };
            })(jQuery);
            function addFiles(playFileName) {

                function filePlay(playFileName) {
//
//                    $.ajax({
//                        type: "GET",
//                        async: false,
//                        url: "http://localhost:3000/prep/" + playFileName,
//                        dataType: "JSON",
//                        contentType: "JSON",
//                        success: function (data) {
//                            res = data;
//                            parcel = (res);
//                            if (parcel.error === 'format') {
//                                alert('Не верныйформат файла!');
//                                return;
//                            } else {
//                                Artist = parcel.artist;
//                                Title = parcel.title;
//                                lineArrJson = (parcel.linearrjson);
//                                entryArr = parcel.entryarr;
//                            }
//                        }
//                    });
//                        mp3 = b.substring(entryArr[0].offset, entryArr[0].length1);
//                        var audio = document.createElement('audio');
//                        audio.src = 'data:audio/mpeg;base64,' + btoa(mp3);
//                        audio.play();
//
//                        jpeg = b.substring(entryArr[1].offset, entryArr[1].length1);
//                        var img = document.createElement('img');
//                        t = (readbytes(entryArr[1].offset, a, entryArr[1].length1));
//                        img.src = 'data:image/jpeg;base64,' + hexToBase64(t.join(""));
//                        document.body.appendChild(img);

                    /////Вывод плеера////////////////////////
                    //isBG = true;


                    //bg////////////////////////

                    if(!prepFile(playFileName)){
                        alert('Не верныйформат файла!');
                        return;
                    }
                        
                    var txt = document.getElementById('text');
                    txt.innerHTML = Title + '<br>' + Artist;
                    var width = Math.round($('#text').parent().width() / 2) - Math.round($('#text').width() / 2);
                    var height = Math.round($('#text').parent().height() / 2) - Math.round($('#text').height() / 2);
                    $('#text').css({top: height, left: width, position: 'absolute'});
                    ////////////////////////////

                    for (var i = 0; i < entryArr.length; i++) {
                        entry = entryArr[i];
                        type = entry.type;
                        //if (type === 5) {


//                                var video = document.createElement('video');
//                                video.src = 'data:video/avi;base64,' + btoa(entry.bindata);
//                                video.controls = 'controls';
//                                document.body.appendChild(video);
//                                video.load();
//                                
//                                video.play();
//                                isBG = false;



                        //}
//
//                            if (type === 3 & isBG) {
//
//                                var img = document.createElement('img');
//                                img.src = 'data:image/jpeg;base64,' + btoa(entry.bindata);
//                                document.body.appendChild(img);
//                                isBG = false;
//
//                            }


                        if (type === 2) {


                            var audio = document.getElementById('mp3');
                            if (!audio) {
                                audio = document.createElement('audio');
                                audio.setAttribute("id", "mp3");
                            }
                            currPlayData = 'data:audio/mpeg;base64,' + btoa(entry.bindata);
                            audio.src = 'data:audio/mpeg;base64,' + btoa(entry.bindata);
                            console.log('play');
                            $('#text').css({top: height, left: width, position: 'absolute'});
                            audio.setAttribute('controls', 'controls');
                            audio.setAttribute('preload', 'auto');
                            duration = audio.duration;
                            document.getElementById('workplace').appendChild(audio);
                            var width = ($('#text').parent().width() / 2) - ($('#text').width() / 2);
                            var height = ($('#text').parent().height() / 2) - ($('#text').height() / 2);
                            $('#text').css({top: height, left: width, position: 'absolute'});
                            audio.addEventListener("play", function () {

                            });
                            function buildText(timeSec) {

                                var time1 = null;
                                var time2 = null;
                                var findLinePos = null;
                                var findSplitPos = null;
                                if (timeSec < parseInt(lineArrJson[0].timeSplit[0])) {//до первого тайминга
                                    findLinePos = null;
                                    findSplitPos = null;
                                    txt.innerHTML = lineArrJson[0].lineText + '</br>' + lineArrJson[1].lineText;
                                    var width = ($('#text').parent().width() / 2) - ($('#text').width() / 2);
                                    var height = ($('#text').parent().height() / 2) - ($('#text').height() / 2);
                                    $('#text').css({top: height, left: width, position: 'absolute'});
                                    time1 = 0;
                                    time2 = lineArrJson[0].timeSplit[0];


                                }
                                if (timeSec > parseInt(lineArrJson[lineArrJson.length - 1].timeSplit[lineArrJson[lineArrJson.length - 1].timeSplit.length - 1])) {//после последнего тайминга
                                    findLinePos = null;
                                    findSplitPos = null;
//                                    txt.innerHTML = lineArrJson[0].lineText + '</br>' + lineArrJson[1].lineText;
//                                    var width = ($('#text').parent().width() / 2) - ($('#text').width() / 2);
//                                    var height = ($('#text').parent().height() / 2) - ($('#text').height() / 2);
//                                    $('#text').css({top: height, left: width, position: 'absolute'});
                                    time1 = parseInt(lineArrJson[lineArrJson.length - 1].timeSplit[lineArrJson[lineArrJson.length - 1].timeSplit.length - 1]);
                                    time2 = parseInt(lineArrJson[lineArrJson.length - 1].timeSplit[lineArrJson[lineArrJson.length - 1].timeSplit.length - 1]);
                                    findLinePos = lineArrJson.length - 1;
                                    findSplitPos = lineArrJson[lineArrJson.length - 1].timeSplit.length - 1;

                                }
                                for (var k = 0; k < lineArrJson.length & time1 === null; k++) {
                                    var i = 0;
                                    while (i < lineArrJson[k].timeSplit.length) {


                                        nextSplitTime = lineArrJson[k].timeSplit[i];//тот же тайминг
                                        if (i !== lineArrJson[k].timeSplit.length - 1) {
                                            nextSplitTime = lineArrJson[k].timeSplit[i + 1];//следующий тайминг в тойже строке
                                        } else if (k !== lineArrJson.length - 1) {
                                            nextSplitTime = lineArrJson[k + 1].timeSplit[0];//следующий тайминг в следующей строке
                                        }
                                        time2 = nextSplitTime;
                                        if ((timeSec >= parseInt(lineArrJson[k].timeSplit[i])) & (timeSec <= parseInt(nextSplitTime))) {
                                            findLinePos = k;
                                            findSplitPos = i;
                                            time1 = lineArrJson[findLinePos].timeSplit[findSplitPos];
                                            break;
                                        }



                                        i++;
                                    }


                                }



                                //проигрыш от 5 сек////////////////////////////////
                                if (time2 - time1 >= 500) {
                                    console.log(time1 + ' ' + time2);
                                    //$('#progressb').show();
                                    var width = ($('#progressb').parent().width() / 2) - ($('#progressb').width() / 2);
                                    var height = ($('#progressb').parent().height() / 1.40) - ($('#progressb').height());
                                    $('#progressb').css({top: height, left: width, zIndex: 299});
                                    var delta = null;
//                                    var progress = (timeSec - time1) / (time2 - time1) * 100 + "%";
                                    progress = (timeSec - time1) / (time2 - time1) * 100;
                                    delta = Math.round((time2 - timeSec) / 100);
                                    //console.log(delta);

                                    if (delta < 3) {
                                        delta++;
                                        $('#countdown').html('<font size ="30px" color = "white"><strong>' + delta + '</strong></font>');
                                        $('#countdown').css({zIndex: 300});
                                    } else {
                                        $('#countdown').css({zIndex: -1});
                                    }


//                                    $('#progressfill').css({width: progress});
                                    $('#progressb').progressbar({
                                        value: progress
                                    });
                                } else {
                                    $('#progressb').css({zIndex: -1});
                                    $('#countdown').css({zIndex: -1});
                                    $('#progressfill').css({width: '0%'});
                                    // $('#progressb').hide();

                                }
                                ;
                                //////////////////////////////////////////////////                                



                                drawText(findLinePos, findSplitPos, timeSec);
                            }

                            function drawText(findLinePos, findSplitPos, timeSec) {
                                var redPart = '';
                                var whitePart = '';
                                cTxt = $('#text').text();
                                if (findLinePos !== null) {
                                    //if (findSplitPos > 0) {//есть красное
                                    redPart = lineArrJson[findLinePos].wordSplit.slice(0, findSplitPos + 1).join('');
                                    whitePart = lineArrJson[findLinePos].wordSplit.slice(findSplitPos + 1, lineArrJson[findLinePos].wordSplit.length).join('');
                                    if (findLinePos % 2 === 0 & findLinePos < lineArrJson.length - 1) {//первая

                                        txt.innerHTML = '<font  color="red">' + redPart + '</font>' + whitePart + '</br>' + lineArrJson[findLinePos + 1].lineText;
                                    } else if (findLinePos % 2 === 1) {//вторая
                                        txt.innerHTML = '<font  color="red">' + lineArrJson[findLinePos - 1].lineText + '</br>' + redPart + '</font>' + whitePart;
                                        if ((findSplitPos === lineArrJson[findLinePos].wordSplit.length - 1)) {
                                            if (timeSec > (parseInt(lineArrJson[findLinePos].timeSplit[findSplitPos]) + 50)) {



                                                nextWhite1 = '';
                                                nextWhite2 = '';
                                                if (findLinePos + 1 <= lineArrJson.length - 1) {
                                                    nextWhite1 = lineArrJson[findLinePos + 1].lineText;
                                                }
                                                if (findLinePos + 2 <= lineArrJson.length - 1) {
                                                    nextWhite2 = lineArrJson[findLinePos + 2].lineText;
                                                }
                                                if (nextWhite1 !== '') {
                                                    txt.innerHTML = nextWhite1 + '</br>' + nextWhite2;
                                                }
                                            }
                                        }
                                    } else if (findLinePos % 2 === 0 & findLinePos === lineArrJson.length - 1) {//первая, но последняя
                                        txt.innerHTML = '<font  color="red">' + redPart + '</font>' + whitePart;
                                    }

                                }
                                if (cTxt.replace(/\s/g, "") !== $('#text').text().replace(/\s/g, "")) {
                                    var width = ($('#text').parent().width() / 2) - ($('#text').width() / 2);
                                    var height = ($('#text').parent().height() / 2) - ($('#text').height() / 2);
                                    $('#text').css({top: height, left: width, position: 'absolute'});
                                }
                            }


                            audio.addEventListener("timeupdate", function () {
                                ct = audio.currentTime * 100; //by 100 ms

                                buildText(ct);
                            });
                            ci = 0;
                            audio.play();
                            var width = ($('#mp3').parent().width() / 2) - ($('#mp3').width() / 2);
                            var height = ($('#mp3').parent().height() / 1.15) - ($('#mp3').height());
                            $('#mp3').css({top: height, left: width, position: 'absolute'});
                            $('#countdown').html('<font size ="30px" color = "white"><strong>' + 3 + '</strong></font>');
                            var width = ($('#countdown').parent().width() / 2) - ($('#countdown').width() / 2);
                            var height = ($('#countdown').parent().height() / 1.40) - ($('#countdown').height());
                            $('#countdown').css({top: height, left: width});
                            return;
                        }

                    }
                    //};





                    ////////////////////////////////////////////


                }
                ;
                filePlay(playFileName);
                //reader.readAsArrayBuffer(input.files[0]); 



            }////конец главной функции      
            ;
            function load() {
                //$('#progressb').hide();
                var img = document.getElementById('image');
                var n = Math.floor(Math.random() * (10) + 1) / 1;
                var bindata = getFileBinary('images%5C' + n + '.jpg');
                img.src = 'data:image/jpeg;base64,' + btoa(bindata);
//                var vid = document.getElementById('video');
//                var bindata = getFileBinary('images%5C1.webm');
//                vid.src = 'data:video/webm;base64,' + btoa(bindata);
//                //vid.type = 'video/webm';
//                vid.load();
//                vid.play();
//                var elem = document.getElementById("video");
//                if (elem.requestFullscreen) {
//                    elem.requestFullscreen();
//                } else if (elem.msRequestFullscreen) {
//                    elem.msRequestFullscreen();
//                } else if (elem.mozRequestFullScreen) {
//                    elem.mozRequestFullScreen();
//                } else if (elem.webkitRequestFullscreen) {
//                    elem.webkitRequestFullscreen();
//                }

                window.addEventListener('resize', () => {
                    var width = ($('#mp3').parent().width() / 2) - ($('#mp3').width() / 2);
                    var height = ($('#mp3').parent().height() / 1.15) - ($('#mp3').height());
                    $('#mp3').css({top: height, left: width, position: 'absolute'});

                    var width = ($('#countdown').parent().width() / 2) - ($('#countdown').width() / 2);
                    var height = ($('#countdown').parent().height() / 1.40) - ($('#countdown').height());
                    $('#countdown').css({top: height, left: width});

                    var width = ($('#text').parent().width() / 2) - ($('#text').width() / 2);
                    var height = ($('#text').parent().height() / 2) - ($('#text').height() / 2);
                    $('#text').css({top: height, left: width, position: 'absolute'});
                });

                $(function () {

                });

            }



        </script>
        <style>

            body {
                overflow: hidden;

            }
            #container {

                width: 100vw;
                height: 100vh;

            }
            #image {

                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 100%;  
                /*z-index: 50;*/
            }
            #video {

                /*position: absolute;*/
                /*                left: 0;
                                top: 0;*/
                width: auto;
                height: auto;           
            }

            #text {
                z-index: 100;
                color: white;

                font-weight: bold;
                position: absolute;
                font-size: 60px;
                text-shadow: 1px 1px 1px #000;



            }
            #mp3 {
                z-index: 100;
                position: absolute;
                /*                left: 0;
                                margin: 0;*/
                /*text-align: center;*/


            }
            #form1 {
                z-index: 100;
                position: absolute;
                left: 400px;
            }
            #progressb {
                z-index:-1;
                position: absolute;
                left: 50vw;
                top: 75vh;
                width: 250px;
                text-align: center;
                height: 20px;
                opacity: 0.6;

                /*display: none;*/
            }
            /*            #progressfill {
                            font-weight:bold;
            
                        }*/
            #countdown {
                z-index:-1;
                position: absolute;
            }
            .ui-progressbar-value {
                background-image: url(http://www.professorweb.ru/downloads/jquery/progress-animation.gif);
            }
            .ui-progressbar {
                height: 22px;
            }




            form {

                position: relative;
                width: 300px;
                margin: 10px;

            }
            .d1 {background: #464646;}
            .d1 input {

                width: 100%;
                height: 30px;
                padding-left: 10px;
                border: 2px solid #7BA7AB;
                border-radius: 5px;
                outline: none;
                background: #F9F0DA;
                color: #9E9C9C;
                font-family: "Roboto", sans-serif;
            }
            .d1 button {

                position: absolute; 
                top: 0;
                right: 0px;
                width: 30px;
                height: 30px;
                border: none;
                background: #7BA7AB;
                border-radius: 0 5px 5px 0;
                cursor: pointer;
            }
            .d1 button:before {

                content: "\f002";
                font-family: FontAwesome;
                font-size: 16px;
                color: #F9F0DA;
            }

            table {
                width: 300px;
                margin: 10px;
                font: 14px Arial;
                text-align: left;
                border-collapse: collapse;
                border: 2px solid #7BA7AB;

            }

            table th {
                background: #7BA7AB;
                color: white;
                font-family: "Roboto", sans-serif;
            }

            table th,
            table td {
                padding: 5px;
                font-family: "Roboto", sans-serif;
            }

            table tbody tr:nth-child(odd){
                background: #fff;
            }

            table tbody tr:nth-child(even){ 
                background: #f2f6f8;
            }
            a{
                color: #464646;
                text-decoration: none;
                /*                background: silver;
                                padding: 5px;*/
                /*margin: 10px;*/
            }
            #selectSong {
                display: none;
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 30%;  
                background-color: white;
                z-index: 500;

            }
            #closeBtn {

                position: relative;
                padding: 10px;
                float: right;


            }
            #head {

                position: relative;
                padding: 10px;
                float: left;


            }

        </style>

    </head>
    <body onload = 'load()'  ng-controller="myCtrl" ng-init="getPlayList()">

        <!--        <div id ='form1'>
                    <input type="button" value="Играть" onclick="addFiles('downloads%5Ckrug.kfn')">        
                </div>-->
        <div id="container">

            <div id = 'workplace' class="wrapper jsc-sidebar-content jsc-sidebar-pulled">
                <img id="image"/>

                <nav >
                    <a href="#" class="icon-menu link-menu jsc-sidebar-trigger">ПЛЕЙЛИСТ</a>

                </nav>

                <p id="text">                
                </p>
                <!--<audio id='mp3'></audio>-->
                <div  id = 'progressb' >
                    <!--<div id = 'progressfill' class="progress-bar progress-bar-striped  progress-bar-animated" role="progressbar" style="width: 0%; " aria-valuenow="14" aria-valuemin="0" aria-valuemax="100"></div>-->
                </div>
                <div id = 'countdown'></div>
                <div id = 'selectSong'>
                    <div id = 'head' >КАТАЛОГ</div>
                    <div id = 'closeBtn'><a href=""><i class="fa fa-times" aria-hidden="true" title="Закрыть" ng-click = 'closeSelectSong()'></i></a></div>
                    <div id = 'tree'></div>
                </div>
            </div>            

            <nav class="sidebar jsc-sidebar" id="jsi-nav" data-sidebar-options="">

                <form class="d1">
                    <input type="search" placeholder="Искать песню...">
                    <!--<button type="submit"></button>-->
                </form>



                <a href='' style='font-family: "Roboto", sans-serif; margin: 10px; color : white;' ng-click="addSong();"><i class="fa fa-plus" aria-hidden="true" ></i> ДОБАВИТЬ ПЕСНЮ</a>

                <form id = 'transferForm' enctype="multipart/form-data" method="post">
                    <p><input id = 'selectFile' type="file" name="f" accept=".kfn" onchange = '$("#sendFile").click();' hidden>
                        <input id = 'sendFile' type="submit" value="Отправить" hidden></p>
                </form>                 

                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Название песни</th>
                            <th width = 30px>Управление</th>

                        </tr>
                    </thead>
                    <tbody >
                        <tr ng-repeat='song in playList'>
                            <td>{{song.id}}</td>
                            <td>{{song.name}}</td>
                            <td>  
                                <a href=''><i class="fa fa-arrow-up" aria-hidden="true" title='Поднять вверх' ng-click="listUp(song.id)"></i></a>
                                <a href=''><i class="fa fa-arrow-down" aria-hidden="true" title='Опустить вниз' ng-click="listDown(song.id)"></i></a>
                                <a href=''><i class="fa fa-trash" aria-hidden="true" title='Удалить из списка' ng-click="listDelete(song.id)"></i></a>
                                <a href=''><i class="fa fa-play" aria-hidden="true" title='Начать петь' ng-click="play(song.name)"></i></a>
                            </td>

                        </tr>

                    </tbody>
                </table>
            </nav>



            <!--            <img id="image"/>-->
            <!--<video id='video' muted="muted" loop fullscreen></video>-->
            <!--            <p id="text">                
                        </p>
                        <audio id='mp3'></audio>
                        <div  id = 'progressb' >
                            <div id = 'progressfill' class="progress-bar progress-bar-striped  progress-bar-animated" role="progressbar" style="width: 0%; " aria-valuenow="14" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div id = 'countdown'></div>-->

        </div>




        <script>
                    $('#jsi-nav').sidebar({
                        trigger: '.jsc-sidebar-trigger',
                        scrollbarDisplay: true,
                        pullCb: function () {
                            console.log('pull');
                        },
                        pushCb: function () {
                            console.log('push');
                        }
                    });
                    $('#api-push').on('click', function (e) {
                        e.preventDefault();
                        $('#jsi-nav').data('sidebar').push();
                    });
                    $('#api-pull').on('click', function (e) {
                        e.preventDefault();
                        $('#jsi-nav').data('sidebar').pull();
                    });
        </script>


        <!--<script type="text/javascript" src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>-->
        <!--<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">-->
    </body>
</html>















